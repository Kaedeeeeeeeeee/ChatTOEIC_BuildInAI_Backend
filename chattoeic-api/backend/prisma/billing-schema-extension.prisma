// Stripe支付系统数据库扩展
// 需要添加到现有schema.prisma文件中

// 订阅套餐表
model SubscriptionPlan {
  id               String   @id @default(cuid())
  name             String   // "Free Trial", "Premium Monthly"
  nameJp           String?  // 日文名称
  priceCents       Int      // 价格（分为单位，3000日元 = 300000）
  currency         String   @default("jpy")
  interval         String   // "month", "year", "one_time"
  intervalCount    Int      @default(1)
  stripePriceId    String?  @unique
  stripeProductId  String?  @unique
  
  // 功能权限
  features         Json     // {"aiPractice": true, "aiChat": true, "exportData": true}
  
  // 使用限制
  dailyPracticeLimit    Int?    // 每日练习次数限制，null表示无限制
  dailyAiChatLimit      Int?    // 每日AI对话次数限制
  maxVocabularyWords    Int?    // 词汇本单词上限
  
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  
  // 关联
  subscriptions    UserSubscription[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("subscription_plans")
}

// 用户订阅表
model UserSubscription {
  id                    String           @id @default(cuid())
  userId                String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId                String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  
  // Stripe相关字段
  stripeCustomerId      String?
  stripeSubscriptionId  String?          @unique
  stripeSessionId       String?          // 支付会话ID
  
  // 订阅状态
  status                String           // "trialing", "active", "past_due", "canceled", "unpaid"
  
  // 试用期
  trialStart           DateTime?
  trialEnd             DateTime?
  
  // 订阅周期
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean          @default(false)
  canceledAt           DateTime?
  
  // 付款历史
  lastPaymentAt        DateTime?
  nextPaymentAt        DateTime?
  
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  
  @@unique([userId]) // 每个用户只能有一个活跃订阅
  @@map("user_subscriptions")
}

// 使用配额跟踪表
model UsageQuota {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  resourceType String   // "daily_practice", "daily_ai_chat", "vocabulary_words"
  usedCount    Int      @default(0)
  limitCount   Int?     // null表示无限制
  
  // 重置周期
  periodStart  DateTime @default(now())
  periodEnd    DateTime
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([userId, resourceType, periodStart])
  @@map("usage_quotas")
}

// 支付交易记录表
model PaymentTransaction {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  
  stripeSessionId   String?  @unique
  stripePaymentId   String?  @unique
  
  amount            Int      // 金额（分）
  currency          String   @default("jpy")
  status            String   // "pending", "succeeded", "failed", "refunded"
  
  subscriptionId    String?
  subscription      UserSubscription? @relation(fields: [subscriptionId], references: [id])
  
  metadata          Json?    // 额外数据
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("payment_transactions")
}

// 扩展现有User模型（添加这些字段到现有User模型中）
/*
model User {
  // ... 现有字段 ...
  
  // 订阅相关
  subscription      UserSubscription?
  usageQuotas       UsageQuota[]
  paymentTransactions PaymentTransaction[]
  
  // 免费试用
  trialUsed         Boolean   @default(false)  // 是否已使用过免费试用
  trialStartedAt    DateTime? // 试用开始时间
}
*/